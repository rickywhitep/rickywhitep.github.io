<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Cards - Pro Reader</title>
    
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], processEscapes: true },
            options: { enableMenu: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --bg: #000;
            --sidebar-bg: #0a0a0a;
            --accent: #00ffcc;
            --text-main: #fff;
            --text-dim: #888;
            --border: #222;
        }

        * { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 320px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            z-index: 20;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
            color: var(--accent);
            letter-spacing: 1px;
        }

        #tree { flex-grow: 1; overflow-y: auto; padding: 10px; padding-bottom: 100px; }

        .folder-title {
            font-size: 0.7rem;
            color: var(--accent);
            text-transform: uppercase;
            padding: 8px 5px;
            letter-spacing: 1.5px;
            font-weight: 800;
            opacity: 0.95;
        }

        .folder-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 6px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 6px;
            user-select: none;
        }
        .folder-header:hover { background: #0f0f0f; }
        .folder-header .left { display:flex; align-items:center; gap:8px; }
        .caret { display:inline-block; transition: transform 0.15s; font-size: 0.95rem; color: var(--text-dim); }
        .folder-header.open .caret { transform: rotate(90deg); color: var(--accent); }
        .folder-children { padding-left: 10px; display: none; margin-bottom: 8px; border-left: 1px solid var(--border); }
        

        .csv-link {
            padding: 14px 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 2px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }
        .csv-link:active { background: #222; }
        .csv-link.active { color: var(--accent); font-weight: 600; }

        /* Lista de preguntas */
        .q-list { 
            margin-left: 12px; 
            border-left: 1px solid var(--border); 
            display: none; 
            margin-bottom: 10px;
        }
        .csv-link.active + .q-list { display: block !important; }

        .q-item { 
            padding: 10px 15px; 
            font-size: 0.85rem; 
            color: #666; 
            cursor: pointer;
            transition: color 0.2s;
        }
        .q-item.visto { color: var(--accent); font-weight: bold; }
        .q-item.visto::after { content: " ‚úî"; font-size: 0.7rem; }

        /* --- √ÅREA PRINCIPAL --- */
        #main { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            background: var(--bg);
        }

        #btnBack {
            display: none; position: absolute; top: 15px; left: 15px;
            background: #1a1a1a; border: 1px solid #333; color: #fff; 
            padding: 12px 18px; border-radius: 10px; z-index: 30; font-size: 0.9rem;
        }

        .card-viewport {
            flex-grow: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px; text-align: center;
        }

        .card-container { max-width: 800px; width: 100%; }
        #anverso { font-size: 1.8rem; line-height: 1.4; margin-bottom: 30px; padding: 0 10px; }
        #reverso { font-size: 1.6rem; color: var(--accent); border-top: 1px dashed #333; padding-top: 30px; display: none; }

        /* --- CONTROLES --- */
        .controls { 
            padding: 25px; 
            display: flex; 
            gap: 12px; 
            justify-content: center; 
            background: linear-gradient(to top, #000, transparent);
        }
        button.nav-btn {
            background: #111; color: #fff; border: 1px solid #222;
            padding: 18px 25px; border-radius: 14px; font-size: 1rem; cursor: pointer; flex: 1; max-width: 150px;
        }
        #btnAction { background: var(--accent); color: #000; font-weight: 800; border: none; max-width: 220px; }

        /* --- RESPONSIVE --- */
        @media (max-width: 900px) {
            #sidebar { width: 100%; position: absolute; height: 100%; }
            /* Mostrar el bot√≥n "Temario" solo cuando estamos viendo una tarjeta (evita tapar el √°rbol) */
            #btnBack { display: none; }
            body.viewing-card #btnBack { display: block; z-index: 100; position: fixed; top: calc(env(safe-area-inset-top, 0px) + 12px); left: 12px; }

            /* Cuando el sidebar est√° oculto, evitar que capture eventos t√°ctiles */
            body.viewing-card #sidebar { transform: translateX(-100%); pointer-events: none; }

            #anverso { font-size: 1.5rem; }
            #reverso { font-size: 1.3rem; }

            /* Mover la botonera arriba para evitar la botonera del sistema en iPhone */
            .controls {
                position: fixed;
                left: 0;
                right: 0;
                top: calc(env(safe-area-inset-top, 0px) + 12px);
                padding: 8px 16px;
                z-index: 90;
                justify-content: center;
                width: 100%;
                box-sizing: border-box;
                display: flex;
                gap: 12px;
                pointer-events: auto;
            }
            .controls .nav-btn { max-width: 150px; }

            /* Dejar espacio superior para la botonera y evitar que el contenido quede atr√°s */
            .card-viewport { padding-top: calc(env(safe-area-inset-top, 0px) + 80px); padding-bottom: 24px; }

            /* No ocupar la ventana completa en vertical para dejar espacio sobre la botonera del sistema */
            html, body, #main { min-height: calc(100vh - env(safe-area-inset-bottom, 0px)); }
        }
    </style>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
</head>
<body class="show-menu">

    <div id="sidebar">
        <div class="sidebar-header">RICKY CARDS</div>
        <div id="tree">Cargando temario...</div>
    </div>

    <div id="main">
        <button id="btnBack" onclick="goBack()">‚¨Ö Temario</button>
        <div class="card-viewport">
            <div class="card-container">
                <div id="anverso">Selecciona un bloque para empezar</div>
                <div id="reverso"></div>
            </div>
        </div>
        <div class="controls">
            <button class="nav-btn" onclick="prevCard()">Ant.</button>
            <button class="nav-btn" id="btnAction" onclick="toggleCard()">MOSTRAR</button>
            <button class="nav-btn" onclick="nextCard()">Sig.</button>
        </div>
    </div>

<script>
    const repoOwner = 'rickywhitep';
    const repoName = 'rickywhitep.github.io';
    let currentCards = [];
    let currentIndex = 0;
    let showingAnswer = false;
    let currentKey = null; // key for progress (e.g. file path)

    // ----- IndexedDB helpers (very small wrapper) -----
    function openDB() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open('ricky-cards', 1);
            req.onupgradeneeded = () => {
                const db = req.result;
                if (!db.objectStoreNames.contains('progress')) db.createObjectStore('progress', { keyPath: 'file' });
            };
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    }

    async function saveProgress(file, data) {
        if (!file) return;
        try {
            const db = await openDB();
            const tx = db.transaction('progress', 'readwrite');
            const store = tx.objectStore('progress');
            const record = Object.assign({ file, updated_at: new Date().toISOString() }, data);
            store.put(record);
            return tx.complete;
        } catch (e) { console.warn('saveProgress failed', e); }
    }

    async function loadProgress(file) {
        if (!file) return null;
        try {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('progress', 'readonly');
                const store = tx.objectStore('progress');
                const req = store.get(file);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        } catch (e) { console.warn('loadProgress failed', e); return null; }
    }

    function getSeenArray() {
        const activeList = document.querySelector('.csv-link.active + .q-list');
        if (!activeList) return [];
        return Array.from(activeList.children).map((c, i) => c.classList.contains('visto') ? i : -1).filter(i => i >= 0);
    }

    async function loadTree() {
        const treeElement = document.getElementById('tree');
        treeElement.innerHTML = '';
        await loadTreeRecursive('data', treeElement);
    }

    async function loadTreeRecursive(path, parentElement) {
        try {
            const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`;
            const res = await fetch(url);
            const items = await res.json();

            // Ordenar: Carpetas primero
            items.sort((a, b) => (b.type === 'dir') - (a.type === 'dir'));

            for (const item of items) {
                if (item.type === 'dir') {
                    // Contenedor de la carpeta con header plegable
                    const folderGroup = document.createElement('div');
                    folderGroup.className = 'folder-group';

                    const header = document.createElement('div');
                    header.className = 'folder-header';
                    header.innerHTML = `<div class="left"><span class="caret">‚ñ∏</span><span class="folder-title"> ${item.name.toUpperCase()}</span></div>`;

                    const children = document.createElement('div');
                    children.className = 'folder-children';

                    header.onclick = () => {
                        const isOpen = header.classList.toggle('open');
                        children.style.display = isOpen ? 'block' : 'none';
                        const caret = header.querySelector('.caret');
                        if (caret) caret.textContent = isOpen ? '‚ñæ' : '‚ñ∏';
                    };

                    folderGroup.appendChild(header);
                    folderGroup.appendChild(children);
                    parentElement.appendChild(folderGroup);

                    await loadTreeRecursive(item.path, children);
                } else if (item.name.endsWith('.csv')) {
                    const div = document.createElement('div');
                    div.className = 'csv-link';
                    div.innerHTML = `<span>üìÑ ${item.name.replace('.csv', '')}</span>`;
                    
                    const qList = document.createElement('div');
                    qList.className = 'q-list';
                    qList.id = 'list-' + item.sha;
                    qList.style.display = 'none';

                    div.onclick = async (e) => {
                        e.stopPropagation();
                        const isActive = div.classList.contains('active');

                        // Cerrar otros CSV (mantener uno abierto a la vez)
                        document.querySelectorAll('.csv-link').forEach(l => {
                            if (l !== div) {
                                l.classList.remove('active');
                                const sib = l.nextElementSibling;
                                if (sib && sib.classList.contains('q-list')) sib.style.display = 'none';
                            }
                        });

                        if (isActive) {
                            div.classList.remove('active');
                            qList.style.display = 'none';
                            if (window.innerWidth <= 900) document.body.classList.remove('viewing-card');
                        } else {
                            div.classList.add('active');
                            qList.style.display = 'block';
                            await loadCSV(item.download_url, qList.id, item.path);
                        }
                    };

                    parentElement.appendChild(div);
                    parentElement.appendChild(qList);
                }
            }
        } catch (e) { console.error("Error API:", e); }
    }

    async function loadCSV(url, listId, key) {
        currentKey = key || null;
        const res = await fetch(url);
        const data = await res.text();
        currentCards = data.split('\n').filter(l => l.includes(';')).map(l => {
            const p = l.split(';');
            return { a: p[0].trim(), r: p[1].trim() };
        });

        const listContainer = document.getElementById(listId);
        listContainer.innerHTML = '';
        currentCards.forEach((c, idx) => {
            const item = document.createElement('div');
            item.className = 'q-item';
            item.innerText = `Pregunta ${idx + 1}`;
            item.onclick = (e) => {
                e.stopPropagation();
                currentIndex = idx;
                showCard();
                if (window.innerWidth <= 900) document.body.classList.add('viewing-card');
            };
            listContainer.appendChild(item);
        });

        // Restore saved progress if available
        const saved = await loadProgress(key);
        if (saved) {
            if (typeof saved.index === 'number') currentIndex = saved.index;
            if (Array.isArray(saved.seen)) {
                saved.seen.forEach(i => {
                    if (listContainer.children[i]) listContainer.children[i].classList.add('visto');
                });
            }
        } else {
            currentIndex = 0;
        }

        showCard();
    }

    function showCard() {
        if (!currentCards[currentIndex]) return;
        showingAnswer = false;
        document.getElementById('reverso').style.display = 'none';
        document.getElementById('btnAction').innerText = "MOSTRAR";
        document.getElementById('btnAction').style.background = "#00ffcc";
        
        document.getElementById('anverso').innerHTML = currentCards[currentIndex].a;
        document.getElementById('reverso').innerHTML = currentCards[currentIndex].r;
        
        const activeList = document.querySelector('.csv-link.active + .q-list');
        if (activeList) {
            Array.from(activeList.children).forEach(c => c.classList.remove('visto'));
            if(activeList.children[currentIndex]) activeList.children[currentIndex].classList.add('visto');
        }
        // Save progress after showing card
        saveProgress(currentKey, { index: currentIndex, seen: getSeenArray() });
        if (window.MathJax) MathJax.typesetPromise();
    }

    function toggleCard() {
        if (!showingAnswer) {
            document.getElementById('reverso').style.display = 'block';
            document.getElementById('btnAction').innerText = "SIGUIENTE";
            document.getElementById('btnAction').style.background = "#fff";
            showingAnswer = true;
            if (window.MathJax) MathJax.typesetPromise();
        } else {
            nextCard();
        }
    }

    function nextCard() {
        if (currentIndex < currentCards.length - 1) { currentIndex++; showCard(); }
    }

    function prevCard() {
        if (currentIndex > 0) { currentIndex--; showCard(); }
    }

    function goBack() { document.body.classList.remove('viewing-card'); }

    // Register service worker for PWA
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js').then(() => console.log('Service Worker registered')).catch(console.error);
    }

    window.onload = loadTree;
</script>
</body>
</html>