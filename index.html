<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Cards - Pro Reader</title>
    
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], processEscapes: true },
            options: { enableMenu: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --bg: #000;
            --sidebar-bg: #0a0a0a;
            --accent: #00ffcc;
            --text-main: #fff;
            --text-dim: #888;
            --border: #222;
        }

        * { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 320px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            z-index: 20;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
            color: var(--accent);
            letter-spacing: 1px;
        }

        #tree { flex-grow: 1; overflow-y: auto; padding: 10px; padding-bottom: 100px; }

        .folder-title {
            font-size: 0.7rem;
            color: var(--accent);
            text-transform: uppercase;
            padding: 8px 5px;
            letter-spacing: 1.5px;
            font-weight: 800;
            opacity: 0.95;
        }

        .folder-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 6px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 6px;
            user-select: none;
        }
        .folder-header:hover { background: #0f0f0f; }
        .folder-header .left { display:flex; align-items:center; gap:8px; }
        .caret { display:inline-block; transition: transform 0.15s; font-size: 0.95rem; color: var(--text-dim); }
        .folder-header.open .caret { transform: rotate(90deg); color: var(--accent); }
        .folder-children { padding-left: 10px; display: none; margin-bottom: 8px; border-left: 1px solid var(--border); }

        /* Bot√≥n de recarga forzada */
        #btnReload {
            background: transparent;
            border: 1px solid transparent;
            color: var(--accent);
            font-size: 0.95rem;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 8px;
        }
        #btnReload:hover { background: rgba(255,255,255,0.03); border-color: #333; }
        

        .csv-link {
            padding: 14px 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 2px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }
        .csv-link:active { background: #222; }
        .csv-link.active { color: var(--accent); font-weight: 600; }

        /* Lista de preguntas */
        .q-list { 
            margin-left: 12px; 
            border-left: 1px solid var(--border); 
            display: none; 
            margin-bottom: 10px;
        }
        .csv-link.active + .q-list { display: block !important; }

        .q-item { 
            padding: 10px 15px; 
            font-size: 0.85rem; 
            color: #666; 
            cursor: pointer;
            transition: color 0.2s;
        }
        .q-item.visto { color: var(--accent); font-weight: bold; }
        .q-item.visto::after { content: " ‚úî"; font-size: 0.7rem; }

        /* --- √ÅREA PRINCIPAL --- */
        #main { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            background: var(--bg);
        }

        #btnBack {
            display: none; position: absolute; top: 15px; left: 15px;
            background: #1a1a1a; border: 1px solid #333; color: #fff; 
            padding: 12px 18px; border-radius: 10px; z-index: 30; font-size: 0.9rem;
        }

        .card-viewport {
            flex-grow: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px; text-align: center;
        }

        .card-container { max-width: 800px; width: 100%; }
        #anverso { font-size: 1.8rem; line-height: 1.4; margin-bottom: 30px; padding: 0 10px; }
        #reverso { font-size: 1.6rem; color: var(--accent); border-top: 1px dashed #333; padding-top: 30px; display: none; }

        /* --- CONTROLES --- */
        .controls { 
            padding: 25px; 
            display: flex; 
            gap: 12px; 
            justify-content: center; 
            background: linear-gradient(to top, #000, transparent);
        }
        button.nav-btn {
            background: #111; color: #fff; border: 1px solid #222;
            padding: 18px 25px; border-radius: 14px; font-size: 1rem; cursor: pointer; flex: 1; max-width: 150px;
        }
        #btnAction { background: var(--accent); color: #000; font-weight: 800; border: none; max-width: 220px; }

        /* --- RESPONSIVE --- */
        @media (max-width: 900px) {
            #sidebar { width: 100%; position: absolute; height: 100%; }
            /* Mostrar el bot√≥n "Temario" solo cuando estamos viendo una tarjeta (evita tapar el √°rbol) */
            #btnBack { display: none; }
            body.viewing-card #btnBack { display: block; z-index: 100; position: fixed; top: calc(env(safe-area-inset-top, 0px) + 12px); left: 12px; }

            /* Cuando el sidebar est√° oculto, evitar que capture eventos t√°ctiles */
            body.viewing-card #sidebar { transform: translateX(-100%); pointer-events: none; }

            #anverso { font-size: 1.5rem; }
            #reverso { font-size: 1.3rem; }

                /* Mover la botonera abajo para quedar encima de la barra de iOS */
            .controls {
                position: fixed;
                left: 0;
                right: 0;
                bottom: calc(env(safe-area-inset-bottom, 0px) + 12px);
                padding: 8px 16px;
                z-index: 100;
                width: 100%;
                box-sizing: border-box;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 12px;
                pointer-events: auto;
                background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(0,0,0,0.5));
                backdrop-filter: blur(6px);
            }
            .controls .nav-btn { padding: 10px 14px; border-radius: 10px; font-size: 0.95rem; }

            /* Prev/Next anchored to bottom and aligned with the action button */
            .controls .nav-prev, .controls .nav-next {
                position: absolute;
                bottom: calc(env(safe-area-inset-bottom, 0px) + 12px);
                z-index: 101;
                width: 110px;
                max-width: 40%;
            }
            .controls .nav-prev { left: 12px; }
            .controls .nav-next { right: 12px; }

            /* Action button centered at bottom between prev/next */
            .controls #btnAction {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                bottom: calc(env(safe-area-inset-bottom, 0px) + 12px);
                z-index: 101;
                padding: 8px 12px;
                font-size: 0.95rem;
                max-width: 120px;
                border-radius: 10px;
            }

            /* Dejar espacio inferior para la botonera y evitar que el contenido quede atr√°s */
            .card-viewport { padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 84px); padding-top: calc(env(safe-area-inset-top, 0px) + 12px); }

            /* No ocupar la ventana completa en vertical para dejar espacio sobre la botonera del sistema */
            html, body, #main { min-height: calc(100vh - env(safe-area-inset-bottom, 0px)); }
        }
    </style>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
</head>
<body class="show-menu">

    <div id="sidebar">
        <div class="sidebar-header">RICKY CARDS <button id="btnReload" title="Forzar recarga" onclick="forceReload()" aria-label="Forzar recarga">‚ü≥</button></div>  
        <div id="tree">Cargando temario...</div>
    </div>

    <div id="main">
        <button id="btnBack" onclick="goBack()">‚¨Ö Temario</button>
        <div class="card-viewport">
            <div class="card-container">
                <div id="anverso">Selecciona un bloque para empezar</div>
                <div id="reverso"></div>
            </div>
        </div>
        <div class="controls">
            <button class="nav-btn nav-prev" onclick="prevCard()">Ant.</button>
            <button class="nav-btn" id="btnAction" onclick="toggleCard()">MOSTRAR</button>
            <button class="nav-btn nav-next" onclick="nextCard()">Sig.</button>
        </div>
    </div>

<script>
    const repoOwner = 'rickywhitep';
    const repoName = 'rickywhitep.github.io';
    let currentCards = [];
    let currentIndex = 0;
    let showingAnswer = false;
    let currentKey = null; // key for progress (e.g. file path)

    // ----- IndexedDB helpers (very small wrapper) -----
    function openDB() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open('ricky-cards', 1);
            req.onupgradeneeded = () => {
                const db = req.result;
                if (!db.objectStoreNames.contains('progress')) db.createObjectStore('progress', { keyPath: 'file' });
            };
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    }

    async function saveProgress(file, data) {
        if (!file) return;
        try {
            const db = await openDB();
            const tx = db.transaction('progress', 'readwrite');
            const store = tx.objectStore('progress');
            const record = Object.assign({ file, updated_at: new Date().toISOString() }, data);
            store.put(record);
            return tx.complete;
        } catch (e) { console.warn('saveProgress failed', e); }
    }

    async function loadProgress(file) {
        if (!file) return null;
        try {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('progress', 'readonly');
                const store = tx.objectStore('progress');
                const req = store.get(file);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        } catch (e) { console.warn('loadProgress failed', e); return null; }
    }

    function getSeenArray() {
        const activeList = document.querySelector('.csv-link.active + .q-list');
        if (!activeList) return [];
        return Array.from(activeList.children).map((c, i) => c.classList.contains('visto') ? i : -1).filter(i => i >= 0);
    }

    // Simple inline Markdown renderer (supports **bold**, *italic* and `code`), and preserves `$...$` inside backticks as math for MathJax
    function escapeHTML(text) {
        return String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function renderInlineMarkdown(text) {
        if (!text) return '';
        const original = String(text);

        // First, extract backtick code spans and replace with placeholders
        const codePlaceholders = [];
        let placeholderIndex = 0;
        let replaced = original.replace(/`([^`]+?)`/g, (m, inside) => {
            const isMath = /^\s*\$+[\s\S]*\$+\s*$/.test(inside);
            if (isMath) {
                // Preserve math content (do not escape) so MathJax can render it
                const token = `@@MATH${placeholderIndex}@@`;
                codePlaceholders.push({ token, type: 'math', content: inside.trim() });
                placeholderIndex++;
                return token;
            } else {
                // Regular code: escape and wrap in <code>
                const token = `@@CODE${placeholderIndex}@@`;
                codePlaceholders.push({ token, type: 'code', content: escapeHTML(inside) });
                placeholderIndex++;
                return token;
            }
        });

        // Also preserve raw $...$ math outside backticks (supports matching same number of $ delimiters, e.g. $..$, $$..$$, $$$..$$$)
        replaced = replaced.replace(/(\${1,})\s*([\s\S]*?)\s*\1/g, (m, delims, inside) => {
            const token = `@@MATH${placeholderIndex}@@`;
            codePlaceholders.push({ token, type: 'math', content: `${delims}${inside.trim()}${delims}` });
            placeholderIndex++;
            return token;
        });

        // Escape the rest of the text
        let out = escapeHTML(replaced);

        // Bold then italic
        out = out.replace(/\*\*(?=\S)([\s\S]*?\S)\*\*/g, '<strong>$1</strong>');
        out = out.replace(/\*(?=\S)([\s\S]*?\S)\*/g, '<em>$1</em>');

        // Restore placeholders: code -> <code>escaped</code>, math -> raw (or code if empty) for MathJax
        for (const ph of codePlaceholders) {
            if (ph.type === 'code') {
                out = out.replace(ph.token, `<code>${ph.content}</code>`);
            } else if (ph.type === 'math') {
                // Decide whether math has inner content after removing delimiters
                const inner = ph.content.replace(/^\$+|\$+$/g, '').trim();
                // If inner is empty or is only punctuation/short non-math token, show as code literal
                // Use a Safari-compatible test for punctuation-only (avoid Unicode property escapes)
                const isPunctuationOnly = /^[^\w\s]+$/.test(inner);
                const isShortNonAlnum = inner.length <= 2 && !/[A-Za-z0-9\\{}\[\]]/.test(inner);
                if (!inner || isPunctuationOnly || isShortNonAlnum) {
                    // nothing useful inside math delimiters or just punctuation: show as code literal WITHOUT $ delimiters
                    out = out.replace(ph.token, `<code>${escapeHTML(inner || ph.content)}</code>`);
                } else {
                    // normalize spacing around inner content and keep same number of $ delimiters
                    const m = ph.content.match(/^(\$+)[\s\S]*?(\$+)$/);
                    if (m) {
                        const normalized = ph.content.replace(/^(\$+)\s*([\s\S]*?)\s*(\$+)$/, (all, o, ins, c) => o + ins.trim() + c);
                        out = out.replace(ph.token, normalized);
                    } else {
                        out = out.replace(ph.token, ph.content);
                    }
                }
            }
        }

        return out;
    }

    // Simple cache helpers (localStorage-backed) - 5 minute TTL
    const API_CACHE_TTL = 5 * 60 * 1000; // 5 minutes
    async function fetchJsonWithCache(url) {
        const key = 'api_cache:' + url;
        try {
            const raw = localStorage.getItem(key);
            if (raw) {
                const obj = JSON.parse(raw);
                if (Date.now() - obj.ts < API_CACHE_TTL) return obj.data;
            }
        } catch (e) { /* ignore */ }
        const res = await fetch(url);
        const data = await res.json();
        try { localStorage.setItem(key, JSON.stringify({ ts: Date.now(), data })); } catch (e) {}
        return data;
    }

    async function fetchTextWithCache(url) {
        const key = 'api_cache_text:' + url;
        try {
            const raw = localStorage.getItem(key);
            if (raw) {
                const obj = JSON.parse(raw);
                if (Date.now() - obj.ts < API_CACHE_TTL) return obj.data;
            }
        } catch (e) { /* ignore */ }
        const res = await fetch(url);
        const data = await res.text();
        try { localStorage.setItem(key, JSON.stringify({ ts: Date.now(), data })); } catch (e) {}
        return data;
    }

    // Limpia la cach√© local de API/CSV (prefijos utilizados por fetchJsonWithCache / fetchTextWithCache)
    function clearApiCache() {
        try {
            Object.keys(localStorage).forEach(k => {
                if (k.startsWith('api_cache:') || k.startsWith('api_cache_text:')) localStorage.removeItem(k);
            });
        } catch (e) { console.warn('clearApiCache failed', e); }
    }

    // Forzar recarga del √°rbol (usa clearApiCache y recarga)
    async function forceReload() {
        const treeElement = document.getElementById('tree');
        treeElement.innerHTML = '<div style="padding:12px;color:#888;">Forzando recarga...</div>';
        clearApiCache();
        try {
            await loadTree();
        } catch (e) {
            treeElement.innerHTML = `<div style="padding:12px;color:#f88;">Error recargando: ${escapeHTML(e.message || e)}</div>`;
        }
    }

    async function loadTree() {
        const treeElement = document.getElementById('tree');
        treeElement.innerHTML = '';
        await loadTreeRecursive('data', treeElement);
    }

    async function loadTreeRecursive(path, parentElement) {
        try {
            const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`;
            const items = await fetchJsonWithCache(url);

            // If API returns an error object (eg. rate limit), show it in the UI instead of failing silently
            if (!Array.isArray(items)) {
                const msg = items && (items.message || items.error || JSON.stringify(items));
                parentElement.innerHTML = `<div style="padding:12px;color:#f88;">Error cargando temario: ${escapeHTML(msg)}</div>`;
                console.error('Error fetching repo contents:', items);
                return;
            }

            // Ordenar: Carpetas primero
            items.sort((a, b) => (b.type === 'dir') - (a.type === 'dir'));

            for (const item of items) {
                if (item.type === 'dir') {
                    // Contenedor de la carpeta con header plegable
                    const folderGroup = document.createElement('div');
                    folderGroup.className = 'folder-group';

                    const header = document.createElement('div');
                    header.className = 'folder-header';
                    header.innerHTML = `<div class="left"><span class="caret">‚ñ∏</span><span class="folder-title"> ${item.name.toUpperCase()}</span></div>`;

                    const children = document.createElement('div');
                    children.className = 'folder-children';
                    children.style.display = 'none';

                    header.onclick = async () => {
                        const isOpen = header.classList.toggle('open');
                        children.style.display = isOpen ? 'block' : 'none';
                        const caret = header.querySelector('.caret');
                        if (caret) caret.textContent = isOpen ? '‚ñæ' : '‚ñ∏';

                        if (isOpen && !header.dataset.loaded) {
                            header.dataset.loaded = '1';
                            children.innerHTML = '<div style="padding:8px;color:#888;">Cargando...</div>';
                            await loadTreeRecursive(item.path, children);
                        }
                    };

                    folderGroup.appendChild(header);
                    folderGroup.appendChild(children);
                    parentElement.appendChild(folderGroup);

                } else if (item.name.endsWith('.csv')) {
                    const div = document.createElement('div');
                    div.className = 'csv-link';
                    div.innerHTML = `<span>üìÑ ${item.name.replace('.csv', '')}</span>`;
                    
                    const qList = document.createElement('div');
                    qList.className = 'q-list';
                    qList.id = 'list-' + item.sha;
                    qList.style.display = 'none';

                    div.onclick = async (e) => {
                        e.stopPropagation();
                        const isActive = div.classList.contains('active');

                        // Cerrar otros CSV (mantener uno abierto a la vez)
                        document.querySelectorAll('.csv-link').forEach(l => {
                            if (l !== div) {
                                l.classList.remove('active');
                                const sib = l.nextElementSibling;
                                if (sib && sib.classList.contains('q-list')) sib.style.display = 'none';
                            }
                        });

                        if (isActive) {
                            div.classList.remove('active');
                            qList.style.display = 'none';
                            if (window.innerWidth <= 900) document.body.classList.remove('viewing-card');
                        } else {
                            div.classList.add('active');
                            qList.style.display = 'block';
                            await loadCSV(item.download_url, qList.id, item.path);
                        }
                    };

                    parentElement.appendChild(div);
                    parentElement.appendChild(qList);
                }
            }
        } catch (e) { console.error("Error API:", e); parentElement.innerHTML = `<div style="padding:12px;color:#f88;">Error cargando temario: ${escapeHTML(e.message || e)}</div>`; }
    }

    async function loadCSV(url, listId, key) {
        currentKey = key || null;
        const data = await fetchTextWithCache(url);
        currentCards = data.split('\n').filter(l => l.includes(';')).map(l => {
            const p = l.split(';');
            return { a: p[0].trim(), r: p[1].trim() };
        });

        const listContainer = document.getElementById(listId);
        listContainer.innerHTML = '';
        currentCards.forEach((c, idx) => {
            const item = document.createElement('div');
            item.className = 'q-item';
            item.innerText = `Pregunta ${idx + 1}`;
            item.onclick = (e) => {
                e.stopPropagation();
                currentIndex = idx;
                showCard();
                if (window.innerWidth <= 900) document.body.classList.add('viewing-card');
            };
            listContainer.appendChild(item);
        });

        // Restore saved progress if available
        const saved = await loadProgress(key);
        if (saved) {
            if (typeof saved.index === 'number') currentIndex = saved.index;
            if (Array.isArray(saved.seen)) {
                saved.seen.forEach(i => {
                    if (listContainer.children[i]) listContainer.children[i].classList.add('visto');
                });
            }
        } else {
            currentIndex = 0;
        }

        showCard();
    }

    function showCard() {
        if (!currentCards[currentIndex]) return;
        showingAnswer = false;
        document.getElementById('reverso').style.display = 'none';
        document.getElementById('btnAction').innerText = "MOSTRAR";
        document.getElementById('btnAction').style.background = "#00ffcc";
        
        document.getElementById('anverso').innerHTML = renderInlineMarkdown(currentCards[currentIndex].a);
        document.getElementById('reverso').innerHTML = renderInlineMarkdown(currentCards[currentIndex].r);
        
        const activeList = document.querySelector('.csv-link.active + .q-list');
        if (activeList) {
            Array.from(activeList.children).forEach(c => c.classList.remove('visto'));
            if(activeList.children[currentIndex]) activeList.children[currentIndex].classList.add('visto');
        }
        // Save progress after showing card
        saveProgress(currentKey, { index: currentIndex, seen: getSeenArray() });
        if (window.MathJax) MathJax.typesetPromise();
    }

    function toggleCard() {
        if (!showingAnswer) {
            document.getElementById('reverso').style.display = 'block';
            document.getElementById('btnAction').innerText = "SIGUIENTE";
            document.getElementById('btnAction').style.background = "#fff";
            showingAnswer = true;
            if (window.MathJax) MathJax.typesetPromise();
        } else {
            nextCard();
        }
    }

    function nextCard() {
        if (currentIndex < currentCards.length - 1) { currentIndex++; showCard(); }
    }

    function prevCard() {
        if (currentIndex > 0) { currentIndex--; showCard(); }
    }

    function goBack() { document.body.classList.remove('viewing-card'); }

    // Register service worker for PWA
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js').then(() => console.log('Service Worker registered')).catch(console.error);
    }

    window.onload = loadTree;
</script>
</body>
</html>